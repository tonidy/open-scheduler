syntax = "proto3";

package scheduler;

option go_package = "github.com/open-scheduler/proto";

// Heartbeat message sent from Agent (Data Plane) to Centro (Control Plane)
message HeartbeatRequest {
  string node_id = 1;
  int64 timestamp = 2;
  float available_memory_mb = 3;   // Available RAM in MB
  float available_cpu_cores = 4;   // Available CPU in cores (e.g., 4.0 = 4 cores, 2.5 = 2.5 cores)
  float available_disk_mb = 5;     // Available disk space in MB
  map<string, string> node_metadata = 6; // Additional node metadata
  string cluster_name = 7;         // Cluster this node belongs to
}

message HeartbeatResponse {
  bool acknowledged = 1;
  string response_message = 2;
}

// Request from Agent to get an available job from Centro
message GetJobRequest {
  string node_id = 1;
}

// Job specification, inspired by Nomad job spec (simplified)
message Job {
  string job_id = 1;
  string job_name = 2;
  string job_type = 3;              // Job type: "service", "batch", etc.
  repeated string selected_clusters = 4; // Clusters where this job can run (empty = any cluster)

  repeated Task tasks = 5;
  map<string, string> job_metadata = 6; // Job-level metadata
}

message Task {
  string task_name = 1;
  string driver_type = 2;        // Driver type: "podman", "incus", "exec"
  string command = 3;             // Command or script to execute
  ContainerSpec container_config = 4;
  map<string, string> environment_variables = 5;
  Resources resource_requirements = 6;
  repeated Volume volume_mounts = 7;
  string workload_type = 8;       // Workload type: "container", "vm", "process"
}

// Resource requirements and limits for task execution
message Resources {
  int64 memory_limit_mb = 1;      // Maximum memory in MB
  int64 memory_reserved_mb = 2;   // Reserved/guaranteed memory in MB
  float cpu_limit_cores = 3;      // CPU limit in cores (e.g., 1.0 = 1 core, 0.5 = half core)
  float cpu_reserved_cores = 4;   // Reserved/guaranteed CPU in cores
}

// Volume mount specification for binding host paths to container/VM paths
message Volume {
  string source_path = 1;      // Path on the host system
  string target_path = 2;      // Path inside the container/VM
  bool read_only = 3;          // Whether the mount is read-only
}

// Container/image specification for containerized workloads
message ContainerSpec {
  string image_name = 1;             // Container image (e.g., "nginx:latest")
  repeated string entrypoint = 2;    // Entrypoint command to run in the container
  repeated string arguments = 3;     // Arguments for the entrypoint command
  map<string, string> driver_options = 4; // Driver-specific configuration options
}

message GetJobResponse {
  bool job_available = 1;       // Whether a job is available for execution
  Job job = 2;
  string response_message = 3;
}

// Status update from Agent to Centro about job execution
message UpdateStatusRequest {
  string node_id = 1;
  string job_id = 2;
  string job_status = 3;        // Job status: "pending", "running", "completed", "failed"
  string status_message = 4;    // Detailed status message or error description
  int64 timestamp = 5;
}

message UpdateStatusResponse {
  bool acknowledged = 1;
  string response_message = 2;
}

// Container inspection data sent from Agent to Centro after container is running
message ContainerData {
  string container_id = 1;         // Container ID
  string container_name = 2;       // Container name
  string image = 3;                // Full image identifier
  string image_name = 4;           // Image name (e.g., "nginx:latest")
  repeated string command = 5;     // Command executed in container
  repeated string args = 6;        // Arguments passed to command
  string created = 7;              // Creation timestamp
  string started_at = 8;           // Container start timestamp
  string finished_at = 9;          // Container finish timestamp (if stopped)
  string status = 10;              // Container status: "running", "stopped", "exited", "failed"
  int32 exit_code = 11;            // Exit code (if stopped)
  int32 pid = 12;                  // Process ID
  map<string, string> labels = 13; // Container labels
  repeated string ports = 14;      // Exposed ports
  repeated string volumes = 15;    // Mounted volumes
}

message SetContainerDataRequest {
  string node_id = 1;              // Node ID where container is running
  string job_id = 2;               // Job ID associated with the container
  ContainerData container_data = 3; // Container inspection data
  int64 timestamp = 4;             // Timestamp when data was collected
}

message SetContainerDataResponse {
  bool acknowledged = 1;
  string response_message = 2;
}

// Service provided by Centro (Control Plane) for Agent (Data Plane) communication
service CentroSchedulerService {
  // Agent sends periodic heartbeat to report node health and available resources
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);

  // Agent requests an available job from Centro for execution
  rpc GetJob(GetJobRequest) returns (GetJobResponse);

  // Agent sends job execution status updates to Centro
  rpc UpdateStatus(UpdateStatusRequest) returns (UpdateStatusResponse);

  // Agent sends container inspection data after container is running
  rpc SetContainerData(SetContainerDataRequest) returns (SetContainerDataResponse);
}

