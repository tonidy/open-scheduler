syntax = "proto3";

package scheduler;

option go_package = "github.com/open-scheduler/proto";

// Heartbeat message sent from Agent (Data Plane) to Centro (Control Plane)
message HeartbeatRequest {
  string node_id = 1;
  int64 timestamp = 2;
  float available_memory_mb = 3;   // Available RAM in MB
  float available_cpu_cores = 4;   // Available CPU in cores (e.g., 4.0 = 4 cores, 2.5 = 2.5 cores)
  float available_disk_mb = 5;     // Available disk space in MB
  map<string, string> node_metadata = 6; // Additional node metadata
  string cluster_name = 7;         // Cluster this node belongs to
}

message HeartbeatResponse {
  bool acknowledged = 1;
  string response_message = 2;
}

// Request from Agent to get an available job from Centro
message GetJobRequest {
  string node_id = 1;
}

// Job specification - simplified model where each job runs exactly one instance (container or VM)
message Job {
  string job_id = 1;
  string job_name = 2;
  string job_type = 3;              // Job type: "service", "batch", etc.
  repeated string selected_clusters = 4; // Clusters where this job can run (empty = any cluster)

  // Job execution configuration (merged from Task)
  string driver_type = 5;        // Driver type: "podman", "incus", "exec"
  string command = 6;             // Command or script to execute
  InstanceSpec instance_config = 7;  // Instance configuration (for containers, VMs, etc.)
  map<string, string> environment_variables = 8;
  Resources resource_requirements = 9;
  repeated Volume volume_mounts = 10;
  string workload_type = 11;       // Workload type: "container", "vm", "process"
  map<string, string> job_metadata = 12; // Job-level metadata
  
  // Job retry and failure tracking
  int32 retry_count = 13;          // Number of times this job has been retried
  int32 max_retries = 14;          // Maximum number of retries allowed (0 = no limit)
  int64 last_retry_time = 15;      // Unix timestamp of last retry attempt
}

// Resource requirements and limits for job execution
message Resources {
  int64 memory_limit_mb = 1;      // Maximum memory in MB
  int64 memory_reserved_mb = 2;   // Reserved/guaranteed memory in MB
  float cpu_limit_cores = 3;      // CPU limit in cores (e.g., 1.0 = 1 core, 0.5 = half core)
  float cpu_reserved_cores = 4;   // Reserved/guaranteed CPU in cores
}

// Volume mount specification for binding host paths to instance/VM paths
message Volume {
  string source_path = 1;      // Path on the host system
  string target_path = 2;      // Path inside the instance/VM
  bool read_only = 3;          // Whether the mount is read-only
}

// Instance specification for containerized or VM workloads
message InstanceSpec {
  string image_name = 1;             // Image name (e.g., "nginx:latest" for containers, VM image for VMs)
  repeated string entrypoint = 2;    // Entrypoint command to run in the instance
  repeated string arguments = 3;     // Arguments for the entrypoint command
  map<string, string> driver_options = 4; // Driver-specific configuration options
}

message GetJobResponse {
  bool job_available = 1;       // Whether a job is available for execution
  Job job = 2;
  string response_message = 3;
}

// Status update from Agent to Centro about job execution
message UpdateStatusRequest {
  string node_id = 1;
  string job_id = 2;
  string job_status = 3;        // Job status: "pending", "running", "completed", "failed"
  string status_message = 4;    // Detailed status message or error description
  int64 timestamp = 5;
}

message UpdateStatusResponse {
  bool acknowledged = 1;
  string response_message = 2;
}

// Instance inspection data sent from Agent to Centro after instance is running
message InstanceData {
  string instance_id = 1;          // Instance ID
  string instance_name = 2;        // Instance name
  string image = 3;                // Full image identifier
  string image_name = 4;           // Image name (e.g., "nginx:latest")
  repeated string command = 5;     // Command executed in instance
  repeated string args = 6;        // Arguments passed to command
  string created = 7;              // Creation timestamp
  string started_at = 8;           // Instance start timestamp
  string finished_at = 9;          // Instance finish timestamp (if stopped)
  string status = 10;              // Instance status: "running", "stopped", "exited", "failed"
  int32 exit_code = 11;            // Exit code (if stopped)
  int32 pid = 12;                  // Process ID
  map<string, string> labels = 13; // Instance labels
  repeated string ports = 14;      // Exposed ports
  repeated string volumes = 15;    // Mounted volumes
}

message SetInstanceDataRequest {
  string node_id = 1;              // Node ID where instance is running
  string job_id = 2;               // Job ID associated with the instance
  InstanceData instance_data = 3;  // Instance inspection data
  int64 timestamp = 4;             // Timestamp when data was collected
}

message SetInstanceDataResponse {
  bool acknowledged = 1;
  string response_message = 2;
}

// Service provided by Centro (Control Plane) for Agent (Data Plane) communication
service CentroSchedulerService {
  // Agent sends periodic heartbeat to report node health and available resources
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);

  // Agent requests an available job from Centro for execution
  rpc GetJob(GetJobRequest) returns (GetJobResponse);

  // Agent sends job execution status updates to Centro
  rpc UpdateStatus(UpdateStatusRequest) returns (UpdateStatusResponse);

  // Agent sends instance inspection data after instance is running
  rpc SetInstanceData(SetInstanceDataRequest) returns (SetInstanceDataResponse);
}

